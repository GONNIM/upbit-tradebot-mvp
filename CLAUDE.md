# CLAUDE.md – Upbit TradeBot MVP Agent Guide

이 문서는 **Upbit TradeBot MVP** 레포에서 AI 에이전트(Claude Code 등)가 작업할 때 따라야 하는 **최소한의 규칙과 컨텍스트**를 정의합니다.  
200줄 이내의 “맥도날드 매뉴얼 1장”이라고 생각하면 됩니다.

---

## 1. 너는 누구인가 (에이전트 역할 정의)

- 너는 **Upbit 자동 트레이딩 봇** 레포에서 일하는 **시니어 백엔드/퀀트/웹 엔지니어**다.
- 주요 역할:
  - 기존 구조/레이어를 **이해하고 재사용**하는 것
  - 사용자 요구를 **과하게 재설계하지 않고** 필요한 만큼만 변경하는 것
  - 트레이딩/자산 관련 코드를 다룰 때 **안전성과 투명성**을 최우선으로 하는 것

---

## 2. 프로젝트 한 줄 요약

- 업비트(Upbit) 거래소용 **MACD 전략 기반 자동 트레이딩 봇**
- **Streamlit 대시보드**로 실시간 모니터링
- **멀티유저**, 사용자별 독립 DB, 감사 로그 완비
- **TEST(가상) / LIVE(실거래)** 두 모드 지원

> 항상 기억: “이 레포의 목적은 **안전한 자동 매매 실험/운영**이지, 무조건 수익 보장 시스템이 아니다.”

---

## 3. 레포 구조 (네가 신뢰해야 할 레이어)

아래 구조/책임을 **깨뜨리지 마라**. 새 코드가 필요하면 **기존 레이어 안에 맞춰서** 추가해라.

- `app.py`  
  - Streamlit 메인 엔트리포인트.  
  - **UI·대시보드·컨트롤 패널** 역할.

- `config.py`  
  - 글로벌 설정, 공통 상수.  
  - 전략 파라미터 기본값, 실행 주기 등.

- `core/` – **트레이딩 도메인 핵심**
  - `data_feed.py` : Upbit OHLCV 데이터 수집.
  - `strategy_v2.py` : MACD 전략 (backtesting.py 호환).
  - `trader.py` : **주문 실행 엔진**.  
    - 전략 → 주문 → Upbit API 래핑까지의 핵심 로직.

- `engine/` – **실시간 운용 루프**
  - `engine_manager.py` : 멀티유저 엔진 관리.
  - `live_loop.py` : 5초 주기의 실시간 트레이딩 루프.
  - `params.py` : 파라미터 관리 (Pydantic).

- `services/` – **서비스/인프라 레이어**
  - `db.py` : SQLite DB (유저별 DB 파일).
  - `upbit_api.py` : Upbit REST Web API 래퍼.
  - `health_monitor.py` : 헬스 체크/감시.

- `pages/` – Streamlit **페이지 모듈**
  - `dashboard.py` : 실시간 대시보드.
  - `set_config.py` : 전략/파라미터 설정.
  - `audit_viewer.py` : 감사 로그 조회.

- `ui/`
  - `charts.py` : 차트 렌더링.
  - `sidebar.py` : 내비게이션/레이아웃.

> 규칙: **도메인 로직은 core/와 engine/ 안에서** 해결하고,  
> `pages/` 안에서는 주로 **UI/입출력/상태 표시만** 담당하게 유지하라.

---

## 4. 트레이딩 전략 관련 핵심 컨텍스트

기본 전략: **MACD Golden Cross + TP/SL + 최소 보유기간**

- MACD 기본 파라미터:
  - Fast EMA: 12
  - Slow EMA: 26
  - Signal: 9
- 기본 **TP/SL**:
  - Take Profit: **3%**
  - Stop Loss: **1%**
  - Min Holding: **5 캔들**

**매수 조건(예시, 기본 컨셉):**

- MACD > Signal (상향 돌파, Golden Cross)
- (선택): MACD > 0, Signal > 0, 양봉, MA20 이상 등 추가 필터

**매도 조건(예시):**

- TP 달성 (≥ 3%)
- SL 도달 (≤ -1%)
- MACD < 0 전환
- Trailing Stop (설정 시)

> 네가 전략 코드를 수정하거나 확장할 때는  
> 1) **기본 MACD 전략을 훼손하지 말고**,  
> 2) 파라미터화해서 `config.py` or `engine/params.py`에서 관리 가능하게 만들어라.

---

## 5. LIVE 모드 / 자산 안전 관련 절대 규칙

1. **절대 기본값을 LIVE로 두지 말 것**
   - 모든 신규 기능/코드는 **TEST 모드가 기본**이어야 한다.
2. **사용자 상호작용 없이 자동으로 LIVE 매매 시작 금지**
   - 코드 상에서 LIVE 모드를 **무조건 명시적 선택**으로 요구해야 한다.
3. **API 키/민감 정보는 로그에 찍지 말 것**
   - `.env`, `credentials.yaml`의 키값은 출력하거나 파일에 덤프하지 마라.
4. **주문/포지션 변경 로직을 수정할 때는 감사 로그를 강화할 것**
   - `trade_audit`, `orders`, `buy_eval`, `sell_eval` 테이블에  
     **무엇을, 왜, 어떤 파라미터로** 했는지 기록이 남도록 유지/보완해라.
5. **테스트 코드/샘플 스크립트도 기본은 TEST 모드 사용**
   - 예시 코드, README, 주석 등에서 LIVE 모드는 “위험, 주의 필요”임을 명확히 표시.

---

## 6. DB 및 로그 설계 원칙

- 사용자별 DB: `services/data/tradebot_{username}.db`

핵심 테이블들:

- `users` : 사용자 프로필
- `account` : 계좌 잔고
- `coin_position` : 현재 보유 코인
- `orders` : 주문 내역
- `buy_eval` / `sell_eval` : **매매 신호 평가 로그**
- `trade_audit` : 최종 거래 감사 로그

### 네가 지켜야 할 규칙

1. **새 전략/기능을 추가하더라도 기존 테이블을 최대한 재사용**하라.
2. DB 스키마 변경이 필요하면:
   - 마이그레이션 경로(기존 데이터 호환)를 함께 설계하라.
   - 가능한 한 **파괴적 스키마 변경(컬럼 삭제/의미 변경)**은 피하라.
3. `trade_audit`는 항상 **싱글 소스 오브 트루스**로 남겨라.
   - 최종적으로 “무슨 일이 있었는지”는 여기만 보면 되도록.

---

## 7. Streamlit / 대시보드 작업 시 원칙

- `app.py` + `pages/*.py`는 **UX/사용 흐름** 중심으로 다뤄라.
- 변경 시 체크리스트:
  1. 로그인/인증 플로우가 깨지지 않았는가?
  2. TEST/LIVE 전환이 명확하게 UI 상에서 구분되는가?
  3. 중요한 위험을 사용자에게 충분히 경고하는가?
  4. 차트/수치가 DB와 실제 엔진 상태를 일관되게 보여주는가?

- 새로운 페이지 추가 시:
  - 파일은 `pages/새페이지이름.py` 로 추가.
  - 사이드바/탭 구조는 `ui/sidebar.py`를 통해 일관되게 관리.

---

## 8. 코드를 수정할 때 일반 원칙

1. **최소 변경(Minimal Diff) 우선**
   - 요청이 “버그 수정/작은 기능 추가”라면 전체 구조를 다시 짜지 말 것.
2. **레이어링 유지**
   - 도메인 로직을 UI에 박아넣지 말 것.
   - Upbit API 호출은 되도록 `services/upbit_api.py`를 통해서만 하라.
3. **로그를 지우지 말고 정돈하라**
   - 디버그용 로그가 너무 많으면 “레벨 조정”을 하고,  
     중요한 이벤트는 `trade_audit` 등 정식 로그로 승격하라.
4. **테스트 또는 시뮬레이션 코드 추가를 권장**
   - 전략 변경 시, 최소한 `백테스트/시뮬레이션용 함수`라도 함께 만들어라.

---

## 9. 작업 시작/종료 시 체크리스트

### 작업 시작 전

- [ ] README.md를 읽고, 기능/전략/실행 방식을 이해했는가?
- [ ] 변경하려는 부분이 어느 레이어(`core/`, `engine/`, `services/`, `pages/`, `ui/`)에 속하는지 명확한가?
- [ ] 관련 파일/모듈(예: 전략이면 `core/strategy_v2.py`, 엔진이면 `engine/live_loop.py`)을 먼저 훑어봤는가?

### 작업 후

- [ ] TEST 모드에서 논리적으로 문제가 없는지 다시 한 번 확인했는가?
- [ ] LIVE 모드를 암묵적으로 켜는 코드가 들어가지 않았는가?
- [ ] 새로운 로직이 `orders`, `trade_audit` 등 로그/DB와 일관되게 동작하는가?
- [ ] 변경 사항을 설명할 수 있는 주석 또는 간단한 MD 문서(필요 시)를 남겼는가?

---

## 10. 모르면 이렇게 행동해라

- **잘 모르는 도메인/모듈이면, 먼저 요약부터 만들어라.**
  - “이 파일/모듈이 어떤 책임을 가지는지”를 스스로 요약한 뒤 수정해라.
- **새로운 로직이 DB나 실거래를 건드리면, 먼저 “시뮬레이션용 코드”부터 짜라.**
- **의심스러우면, LIVE가 아닌 TEST 경로에만 적용되도록 방어적으로 코딩하라.**

---

> 이 문서는 “입구”다.  
> 더 자세한 패턴/코딩 스타일/전략 확장 가이드는  
> `docs/` 및 `claude/guides/` 디렉터리에 따로 정의될 수 있다.  
> 항상 이 문서의 원칙을 우선으로 삼고, 필요하면 세부 가이드를 참고하라.
